import os
from tqdm import tqdm
DATA_DIR = './Feature_Extraction/Asm_Data/Malware'
DEST_FILE = './Feature_Extraction/malware.csv'
ASM_OPS = ['MOV','PUSH','CALL','CMP','ADD','POP','LEA','TEST',
           'JE','XOR','JMP','JNE','RET','INC','SUB','AND','SHL','OR']


data = []
def get_features(asm_file):
    asm_file_dc = open(asm_file, 'r', encoding='latin-1')
    features = {}
    for op in ASM_OPS:
        features[op.lower()] = 0
    for line in asm_file_dc.readlines():
        line = line.replace('\t',' ')
        for op in ASM_OPS:
            if line.split(' ').count(op.lower()) > 0:
                features[op.lower()] += line.split(' ').count(op.lower())
    return features


result_data_file = open(DEST_FILE, 'w')
csv_initialized = False
for malware_file in tqdm(os.listdir(DATA_DIR)):
    result_data_file = open(DEST_FILE,'a')
    print(malware_file)
    current_features = get_features(DATA_DIR + malware_file)
    if csv_initialized == False:
        current_line = []
        current_line.append('ID')
        for feature in current_features:
            current_line.append(str(feature))
        result_data_file.write(','.join(current_line) + '\n')
        csv_initialized = True
    current_line = []
    current_line.append(malware_file)
    for feature in current_features:
        current_line.append(str(current_features[feature]))
    result_data_file.write(','.join(current_line) + '\n')
    result_data_file.close()